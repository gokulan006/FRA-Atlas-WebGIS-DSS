<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FRA Atlas & WebGIS-DSS - Enhanced</title>
    <link rel="stylesheet" href="style.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <h1 class="header-title">üó∫Ô∏è FRA Atlas & WebGIS-DSS</h1>
            <nav class="header-nav">
                <button class="nav-tab active" data-tab="map">Map View</button>
                <button class="nav-tab" data-tab="digitization">Document Processing</button>
                <button class="nav-tab" data-tab="analytics">Analytics</button>
                <button class="nav-tab" data-tab="reports">Reports</button>
            </nav>
        </div>
    </header>

    <div class="main-container">
        <!-- Left Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-section">
                <h3>üîç Location Filters</h3>
                
                <div class="form-group">
                    <label class="form-label">State</label>
                    <select id="stateFilter" class="form-control">
                        <option value="">All States</option>
                        <option value="Madhya Pradesh">Madhya Pradesh</option>
                        <option value="Odisha">Odisha</option>
                        <option value="Telangana">Telangana</option>
                        <option value="Tripura">Tripura</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">District</label>
                    <select id="districtFilter" class="form-control">
                        <option value="">All Districts</option>
                    </select>
                </div>
            </div>

            <div class="sidebar-section">
                <h3>üìã FRA Claims Filter</h3>
                
                <div class="form-group">
                    <label class="form-label">Claim Type</label>
                    <select id="claimTypeFilter" class="form-control">
                        <option value="">All Types</option>
                        <option value="IFR">Individual Forest Rights (IFR)</option>
                        <option value="CR">Community Rights (CR)</option>
                        <option value="CFR">Community Forest Resource (CFR)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Claim Status</label>
                    <select id="statusFilter" class="form-control">
                        <option value="">All Status</option>
                        <option value="Approved">Approved</option>
                        <option value="Pending">Pending</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                </div>
            </div>

            <div class="sidebar-section">
                <h3>üåø Asset Layers</h3>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="layer-agricultural" checked>
                        <label for="layer-agricultural">üåæ Agricultural Land</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="layer-water" checked>
                        <label for="layer-water">üíß Water Bodies</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="layer-forest" checked>
                        <label for="layer-forest">üå≥ Forest Cover</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="layer-homestead" checked>
                        <label for="layer-homestead">üè† Homesteads</label>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Map Container -->
        <div class="map-container">
            <div class="map-controls">
                <button id="satelliteToggle" class="control-button">üõ∞Ô∏è Satellite View</button>
                <button id="terrainToggle" class="control-button">üóª Terrain View</button>
                <button id="resetView" class="control-button">üîÑ Reset View</button>
            </div>
            <div id="map"></div>
        </div>

        <!-- Right Info Panel -->
        <aside class="info-panel">
            <div class="info-section">
                <h3>üìä Quick Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalClaims">0</div>
                        <div class="stat-label">Total Claims</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="approvedClaims">0</div>
                        <div class="stat-label">Approved</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="pendingClaims">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="rejectedClaims">0</div>
                        <div class="stat-label">Rejected</div>
                    </div>
                </div>
            </div>

            <div class="info-section">
                <h3>üéØ DSS Recommendations</h3>
                <div id="recommendationsList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading recommendations...</p>
                    </div>
                </div>
            </div>

            <div class="info-section">
                <h3>üìç Selected Claim Details</h3>
                <div id="selectedClaimDetails">
                    <p style="color: #666; font-style: italic;">Click on a claim marker to view details</p>
                </div>
            </div>
        </aside>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Main Application JavaScript -->
    <script>
        // Global variables
        let map;
        let fraClaimsLayerGroup;
        let assetLayerGroups = {};
        let allData = {fraClaims: [], governmentSchemes: []};
        let filteredClaims = [];
        let currentSelectedClaim = null;
        let boundaryLayers = {};
        let currentSatelliteLayer = null;

        // Government schemes data (moved from index.html)
        const governmentSchemesData = [
            {
                name: 'PM-KISAN',
                description: 'Pradhan Mantri Kisan Samman Nidhi - Income support scheme for farmers',
                benefit: '‚Çπ6,000 per year in three equal installments'
            },
            {
                name: 'Jal Jeevan Mission',
                description: 'Har Ghar Jal - Providing tap water connection to every household',
                benefit: 'Financial assistance for water connection and infrastructure'
            },
            {
                name: 'MGNREGA',
                description: 'Mahatma Gandhi National Rural Employment Guarantee Act',
                benefit: '100 days of wage employment per year to rural households'
            },
            {
                name: 'DAJGUA',
                description: 'Digital India Land Records Modernization Programme',
                benefit: 'Modernization of land records and settlement operations'
            }
        ];

        // Map initialization
        function initializeMap() {
            // Initialize map centered on India (focusing on target states)
            map = L.map('map').setView([23.5, 80.0], 5);

            // Base layers
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 18
            });

            // Satellite layer (ESRI World Imagery - Free)
            const satelliteLayer = L.tileLayer(
                'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                {
                    attribution: 'Tiles ¬© Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                    maxZoom: 18
                }
            );

            // Terrain layer
            const terrainLayer = L.tileLayer(
                'https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}',
                { attribution: 'Tiles ¬© Esri' }
            );

            // Add default OSM layer
            osmLayer.addTo(map);

            // Store layers for toggling
            window.mapLayers = {
                osm: osmLayer,
                satellite: satelliteLayer,
                terrain: terrainLayer
            };

            // Initialize layer groups
            fraClaimsLayerGroup = L.layerGroup().addTo(map);
            
            // Initialize asset layer groups
            assetLayerGroups = {
                'Agricultural Land': L.layerGroup().addTo(map),
                'Water Body': L.layerGroup().addTo(map),
                'Forest Cover': L.layerGroup().addTo(map),
                'Homestead': L.layerGroup().addTo(map)
            };

            console.log('Map initialized successfully');
        }

        // Data loading and initialization
        function loadData() {
            // Load data from external JSON file
            fetch('mp_fra_demo_30_records.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Data loaded:', data.length, 'records');
                    allData.fraClaims = data;
                    allData.governmentSchemes = governmentSchemesData;
                    initializeFilters();
                    displayClaims(data);
                    updateStatistics(data);
                    generateRecommendations(data);
                })
                .catch(error => {
                    console.error('Error loading data:', error);
                    // Fallback to sample data
                    initializeFallbackData();
                });
        }

        // Fallback sample data if JSON file is not available
        function initializeFallbackData() {
            allData.fraClaims = [
                {
                    id: "FRA001MP",
                    patternHolderName: "Ramesh Kumar Baiga",
                    village: "Jhiriya",
                    district: "Mandla",
                    state: "Madhya Pradesh",
                    claimType: "IFR",
                    area: "2.5 hectares",
                    status: "Approved",
                    lat: 22.5987,
                    lng: 80.3737,
                    dateOfClaim: "2023-03-15",
                    assets: ["Agricultural Land", "Water Body"]
                },
                {
                    id: "FRA002MP",
                    patternHolderName: "Sunita Gond",
                    village: "Bichhiya",
                    district: "Mandla",
                    state: "Madhya Pradesh",
                    claimType: "CFR",
                    area: "40.7 hectares",
                    status: "Pending",
                    lat: 22.4921,
                    lng: 80.5977,
                    dateOfClaim: "2023-05-18",
                    assets: ["Forest Cover", "Medicinal Plants"]
                }
            ];
            
            allData.governmentSchemes = governmentSchemesData;

            initializeFilters();
            displayClaims(allData.fraClaims);
            updateStatistics(allData.fraClaims);
            generateRecommendations(allData.fraClaims);
        }

        // District boundaries data
        const districtBoundaries = {
            "Madhya Pradesh": {
                "Mandla": [[22.4, 80.2], [22.4, 80.6], [22.8, 80.6], [22.8, 80.2], [22.4, 80.2]],
                "Dindori": [[22.7, 80.9], [22.7, 81.3], [23.1, 81.3], [23.1, 80.9], [22.7, 80.9]],
                "Balaghat": [[21.6, 80.0], [21.6, 80.4], [22.0, 80.4], [22.0, 80.0], [21.6, 80.0]],
                "Betul": [[21.7, 77.7], [21.7, 78.1], [22.1, 78.1], [22.1, 77.7], [21.7, 77.7]],
                "Seoni": [[21.9, 79.3], [21.9, 79.7], [22.3, 79.7], [22.3, 79.3], [21.9, 79.3]],
                "Shahdol": [[23.1, 81.2], [23.1, 81.6], [23.5, 81.6], [23.5, 81.2], [23.1, 81.2]],
                "Umaria": [[23.3, 80.7], [23.3, 81.1], [23.7, 81.1], [23.7, 80.7], [23.3, 80.7]],
                "Chhindwara": [[21.9, 78.7], [21.9, 79.1], [22.3, 79.1], [22.3, 78.7], [21.9, 78.7]]
            }
        };

        // Initialize filters
        function initializeFilters() {
            const stateFilter = document.getElementById('stateFilter');
            const districtFilter = document.getElementById('districtFilter');

            // Update district filter based on state selection
            stateFilter.addEventListener('change', function() {
                updateDistrictFilter(this.value);
                showStateBoundary(this.value);
                applyFilters();
            });

            districtFilter.addEventListener('change', function() {
                showDistrictBoundary(stateFilter.value, this.value);
                applyFilters();
            });

            // Other filter event listeners
            document.getElementById('claimTypeFilter').addEventListener('change', applyFilters);
            document.getElementById('statusFilter').addEventListener('change', applyFilters);

            // Asset layer toggles
            document.querySelectorAll('.checkbox-item input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', toggleAssetLayer);
            });
        }

        // Update district filter options
        function updateDistrictFilter(state) {
            const districtFilter = document.getElementById('districtFilter');
            districtFilter.innerHTML = '<option value="">All Districts</option>';

            if (state && allData.fraClaims) {
                const districts = [...new Set(allData.fraClaims
                    .filter(claim => claim.state === state)
                    .map(claim => claim.district))];
                
                districts.forEach(district => {
                    const option = document.createElement('option');
                    option.value = district;
                    option.textContent = district;
                    districtFilter.appendChild(option);
                });
            }
        }

        // Show state boundary
        function showStateBoundary(state) {
            // Clear existing boundaries
            Object.values(boundaryLayers).forEach(layer => {
                map.removeLayer(layer);
            });
            boundaryLayers = {};

            if (state && state !== "") {
                // Create a simple state boundary (this is a simplified example)
                // In a real application, you would use actual GeoJSON boundary data
                const stateBounds = getStateBounds(state);
                if (stateBounds) {
                    const boundaryLayer = L.rectangle(stateBounds, {
                        color: '#ff6b6b',
                        weight: 3,
                        fillOpacity: 0.1,
                        dashArray: '5, 5'
                    }).addTo(map);
                    
                    boundaryLayers.state = boundaryLayer;
                    map.fitBounds(stateBounds);
                }
            }
        }

        // Show district boundary
        function showDistrictBoundary(state, district) {
            // Remove existing district boundary
            if (boundaryLayers.district) {
                map.removeLayer(boundaryLayers.district);
                delete boundaryLayers.district;
            }

            if (state && district && districtBoundaries[state] && districtBoundaries[state][district]) {
                const coords = districtBoundaries[state][district];
                const boundaryLayer = L.polygon(coords, {
                    color: '#4ecdc4',
                    weight: 4,
                    fillOpacity: 0.2
                }).addTo(map);
                
                boundaryLayers.district = boundaryLayer;
                map.fitBounds(boundaryLayer.getBounds());
            }
        }

        // Get state bounds (simplified)
        function getStateBounds(state) {
            const bounds = {
                "Madhya Pradesh": [[21.0, 77.0], [25.0, 82.0]],
                "Odisha": [[17.5, 81.0], [22.5, 87.5]],
                "Telangana": [[15.5, 77.0], [19.5, 81.5]],
                "Tripura": [[22.5, 91.0], [24.5, 92.5]]
            };
            return bounds[state];
        }

        // Display claims on map
        function displayClaims(claims) {
            fraClaimsLayerGroup.clearLayers();

            claims.forEach(claim => {
                const color = getClaimColor(claim.status);
                
                const marker = L.circleMarker([claim.lat, claim.lng], {
                    radius: 8,
                    fillColor: color,
                    color: '#fff',
                    weight: 2,
                    fillOpacity: 0.8
                });

                const popupContent = createPopupContent(claim);
                marker.bindPopup(popupContent);
                
                marker.on('click', function() {
                    selectClaim(claim);
                });

                fraClaimsLayerGroup.addLayer(marker);
            });
        }

        // Get claim color based on status
        function getClaimColor(status) {
            const colors = {
                'Approved': '#28a745',
                'Pending': '#ffc107',
                'Rejected': '#dc3545'
            };
            return colors[status] || '#6c757d';
        }

        // Create popup content
        function createPopupContent(claim) {
            return `
                <div class="custom-popup">
                    <div class="popup-title">${claim.patternHolderName}</div>
                    <div class="popup-details">
                        <strong>ID:</strong> ${claim.id}<br>
                        <strong>Village:</strong> ${claim.village}<br>
                        <strong>District:</strong> ${claim.district}<br>
                        <strong>Type:</strong> ${claim.claimType}<br>
                        <strong>Area:</strong> ${claim.area}<br>
                        <strong>Status:</strong> <span style="color: ${getClaimColor(claim.status)}">${claim.status}</span><br>
                        <strong>Assets:</strong> ${claim.assets.join(', ')}
                    </div>
                </div>
            `;
        }

        // Apply filters
        function applyFilters() {
            const stateFilter = document.getElementById('stateFilter').value;
            const districtFilter = document.getElementById('districtFilter').value;
            const claimTypeFilter = document.getElementById('claimTypeFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            filteredClaims = allData.fraClaims.filter(claim => {
                return (!stateFilter || claim.state === stateFilter) &&
                       (!districtFilter || claim.district === districtFilter) &&
                       (!claimTypeFilter || claim.claimType === claimTypeFilter) &&
                       (!statusFilter || claim.status === statusFilter);
            });

            displayClaims(filteredClaims);
            updateStatistics(filteredClaims);
            generateRecommendations(filteredClaims);
        }

        // Toggle asset layers
        function toggleAssetLayer(event) {
            const layerType = event.target.id.replace('layer-', '');
            const isChecked = event.target.checked;
            
            // This is a placeholder - in a real application, you would have actual asset data
            console.log(`Toggling ${layerType} layer: ${isChecked}`);
        }

        // Update statistics
        function updateStatistics(claims) {
            const total = claims.length;
            const approved = claims.filter(c => c.status === 'Approved').length;
            const pending = claims.filter(c => c.status === 'Pending').length;
            const rejected = claims.filter(c => c.status === 'Rejected').length;

            document.getElementById('totalClaims').textContent = total;
            document.getElementById('approvedClaims').textContent = approved;
            document.getElementById('pendingClaims').textContent = pending;
            document.getElementById('rejectedClaims').textContent = rejected;
        }

        // Generate recommendations - FIXED VERSION
        function generateRecommendations(claims) {
            const recommendationsList = document.getElementById('recommendationsList');
            
            // Clear loading
            recommendationsList.innerHTML = '';

            if (claims.length === 0) {
                recommendationsList.innerHTML = '<p style="color: #666; font-style: italic;">No claims to generate recommendations for.</p>';
                return;
            }

            // Generate recommendations based on all claims
            let html = '<h4>General Recommendations:</h4>';
            
            // Water body recommendations
            const waterClaims = claims.filter(c => c.assets.includes('Water Body'));
            if (waterClaims.length > 0) {
                html += `
                    <div class="scheme-recommendation">
                        <div class="scheme-name">Jal Jeevan Mission Priority</div>
                        <div class="scheme-description">${waterClaims.length} claims have water bodies. Consider prioritizing these for water supply infrastructure.</div>
                        <div class="priority-score">Priority: ${Math.min(90, 70 + waterClaims.length)}%</div>
                    </div>
                `;
            }

            // Agricultural land recommendations
            const agriClaims = claims.filter(c => c.assets.includes('Agricultural Land'));
            if (agriClaims.length > 0) {
                html += `
                    <div class="scheme-recommendation">
                        <div class="scheme-name">PM-KISAN Eligibility</div>
                        <div class="scheme-description">${agriClaims.length} claims have agricultural land. These holders may be eligible for PM-KISAN benefits.</div>
                        <div class="priority-score">Priority: ${Math.min(85, 65 + agriClaims.length)}%</div>
                    </div>
                `;
            }

            // Pending claims
            const pendingClaims = claims.filter(c => c.status === 'Pending');
            if (pendingClaims.length > 0) {
                html += `
                    <div class="scheme-recommendation">
                        <div class="scheme-name">Pending Claims Review</div>
                        <div class="scheme-description">${pendingClaims.length} claims are pending. Consider expediting the review process.</div>
                        <div class="priority-score">Priority: ${Math.min(80, 60 + pendingClaims.length)}%</div>
                    </div>
                `;
            }

            // Approved claims with forest resources
            const approvedForestClaims = claims.filter(c => 
                c.status === 'Approved' && c.assets.includes('Forest Cover')
            );
            if (approvedForestClaims.length > 0) {
                html += `
                    <div class="scheme-recommendation">
                        <div class="scheme-name">Forest Management Support</div>
                        <div class="scheme-description">${approvedForestClaims.length} approved claims involve forest resources. Consider sustainable forest management programs.</div>
                        <div class="priority-score">Priority: 75%</div>
                    </div>
                `;
            }

            // If no specific recommendations, show a message
            if (html === '<h4>General Recommendations:</h4>') {
                html = '<p style="color: #666; font-style: italic;">No specific recommendations at this time.</p>';
            }

            recommendationsList.innerHTML = html;
        }

        // Get scheme recommendations for a specific claim (from index.html)
        function getSchemeRecommendations(claim) {
            const recommendations = [];
            
            allData.governmentSchemes.forEach(scheme => {
                let priority = 0;
                
                // Calculate priority based on claim characteristics
                if (scheme.name === 'PM-KISAN' && claim.assets.includes('Agricultural Land')) {
                    priority = 90;
                } else if (scheme.name === 'Jal Jeevan Mission' && claim.assets.includes('Water Body')) {
                    priority = 85;
                } else if (scheme.name === 'MGNREGA') {
                    priority = 75;
                } else if (scheme.name === 'DAJGUA' && claim.status === 'Approved') {
                    priority = 80;
                }
                
                if (priority > 0) {
                    recommendations.push({ scheme, priority });
                }
            });
            
            return recommendations.sort((a, b) => b.priority - a.priority);
        }

        // Select claim for detailed view
        function selectClaim(claim) {
            currentSelectedClaim = claim;
            const detailsDiv = document.getElementById('selectedClaimDetails');
            
            detailsDiv.innerHTML = `
                <h4>${claim.patternHolderName}</h4>
                <p><strong>Claim ID:</strong> ${claim.id}</p>
                <p><strong>Location:</strong> ${claim.village}, ${claim.district}</p>
                <p><strong>Type:</strong> ${claim.claimType}</p>
                <p><strong>Area:</strong> ${claim.area}</p>
                <p><strong>Status:</strong> <span style="color: ${getClaimColor(claim.status)}">${claim.status}</span></p>
                <p><strong>Date Filed:</strong> ${claim.dateOfClaim}</p>
                <p><strong>Assets:</strong> ${claim.assets.join(', ')}</p>
                
                <div style="margin-top: 15px; border-top: 1px solid #ddd; padding-top: 10px;">
                    <h5>Scheme Recommendations:</h5>
            `;
            
            // Add scheme recommendations for this specific claim
            const recommendations = getSchemeRecommendations(claim);
            if (recommendations.length > 0) {
                recommendations.forEach(rec => {
                    detailsDiv.innerHTML += `
                        <div class="scheme-recommendation" style="margin: 8px 0; padding: 8px; background: #f9f9f9; border-radius: 5px;">
                            <div class="scheme-name">${rec.scheme.name}</div>
                            <div class="scheme-description">${rec.scheme.description}</div>
                            <div class="scheme-benefit"><strong>Benefit:</strong> ${rec.scheme.benefit}</div>
                            <div class="priority-score">Priority: ${rec.priority}%</div>
                        </div>
                    `;
                });
            } else {
                detailsDiv.innerHTML += `<p style="color: #666; font-style: italic;">No specific scheme recommendations for this claim.</p>`;
            }
            
            detailsDiv.innerHTML += `</div>`;
        }

        // Initialize the application
        function init() {
            initializeMap();
            loadData();
            
            // Add event listeners for map controls
            document.getElementById('satelliteToggle').addEventListener('click', function() {
                toggleMapLayer('satellite');
                this.classList.toggle('active');
            });
            
            document.getElementById('terrainToggle').addEventListener('click', function() {
                toggleMapLayer('terrain');
                this.classList.toggle('active');
            });
            
            document.getElementById('resetView').addEventListener('click', function() {
                map.setView([23.5, 80.0], 5);
                // Reset filters
                document.getElementById('stateFilter').value = '';
                document.getElementById('districtFilter').innerHTML = '<option value="">All Districts</option>';
                document.getElementById('claimTypeFilter').value = '';
                document.getElementById('statusFilter').value = '';
                
                // Clear boundaries
                Object.values(boundaryLayers).forEach(layer => {
                    map.removeLayer(layer);
                });
                boundaryLayers = {};
                
                // Show all claims
                displayClaims(allData.fraClaims);
                updateStatistics(allData.fraClaims);
                generateRecommendations(allData.fraClaims);
            });
        }

        // Toggle map layers
        function toggleMapLayer(layerType) {
            // Remove all base layers
            Object.values(window.mapLayers).forEach(layer => {
                map.removeLayer(layer);
            });
            
            // Add the selected layer
            window.mapLayers[layerType].addTo(map);
        }

        // Initialize the application when the DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
